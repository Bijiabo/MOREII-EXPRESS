var MoreiiCustom={resizeWall:function(){$("#wall").height($(window).height()-$("#headerbox").height())},resizeToolbar:function(){$("#toolbar").height($("#styleelementlist").height()+30)},cache:{mouseState:{addElement:!1,moveElement:!1,selectedElement:!1},groupCount:0,getGroup:function(){return MoreiiCustom.cache.groupCount++,MoreiiCustom.cache.groupCount},elementSrc:!1,elementWidth:0,elementHeight:0,elementTop:0,elementLeft:0,ePageX2elementTop:0,ePageY2elementLeft:0,activeElement:null,image:{}},loadImage2Cache:function(){var e=$("#styleelementlist img"),t=e.length;$.each(e,function(e,i){var o=$(i).attr("src"),c=o.match(/(\w+)\/\w+\.\w+$/);c&&(c=c[1]);var a="mii_"+o.match(/\w+\.\w+$/)[0].replace(".","_");MoreiiCustom.cache.image[c]||(MoreiiCustom.cache.image[c]={}),MoreiiCustom.cache.image[c][a]=new Image,MoreiiCustom.cache.image[c][a].src=o,MoreiiCustom.cache.image[c][a].imageIndex=e,MoreiiCustom.cache.image[c][a].onload=function(){var e=Math.round(1/t*95)+Number($("#loading-number").text());e>=100?$("#loading").fadeOut():($("#loading-number").text(" "+e),$("#loading-progress-bar").css("width",e+"%"))}})}},mouseState={addElement:function(e){return void 0===e?MoreiiCustom.cache.mouseState.addElement:(MoreiiCustom.cache.mouseState.addElement=Boolean(e),void(Boolean(e)?$("body").css("cursor","move"):$("body").css("cursor","auto")))},moveElement:function(e){return void 0===e?MoreiiCustom.cache.mouseState.moveElement:(MoreiiCustom.cache.mouseState.moveElement=Boolean(e),void(Boolean(e)?$("body").css("cursor","move"):$("body").css("cursor","auto")))},selectedElement:function(e){if(void 0===e)return MoreiiCustom.cache.mouseState.selectedElement;MoreiiCustom.cache.mouseState.selectedElement=Boolean(e);var t=$("#resize");Boolean(e)?t.css({top:MoreiiCustom.cache.activeElement.offset().top+"px",left:MoreiiCustom.cache.activeElement.offset().left+"px",height:MoreiiCustom.cache.activeElement.css("height"),width:MoreiiCustom.cache.activeElement.css("width"),display:"block"}):t.hide()},resize3:!1},dragElementFromStylelist=function(e){var t=$("#addElement img");MoreiiCustom.cache.elementWidth=t.width(),MoreiiCustom.cache.elementHeight=t.height(),MoreiiCustom.cache.elementTop=e.pageY-MoreiiCustom.cache.elementHeight/2,MoreiiCustom.cache.elementLeft=e.pageX-MoreiiCustom.cache.elementWidth/2,$("#addElement").css({top:MoreiiCustom.cache.elementTop,left:MoreiiCustom.cache.elementLeft})},refreshResize=function(){$("#resize").css({top:MoreiiCustom.cache.activeElement.offset().top+"px",left:MoreiiCustom.cache.activeElement.offset().left+"px",height:MoreiiCustom.cache.activeElement.css("height"),width:MoreiiCustom.cache.activeElement.css("width"),display:"block"})},clearCss=function(e){return Number(String(e).replace("px",""))},overElement=function(e,t){return e.pageX>t.offset().left&&e.pageX<t.offset().left+t.width()&&e.pageY>t.offset().top&&e.pageY<t.offset().top+t.height()?!0:!1},refreshElementCache=function(){MoreiiCustom.cache.elementHeight=MoreiiCustom.cache.activeElement.height(),MoreiiCustom.cache.elementWidth=MoreiiCustom.cache.activeElement.width(),MoreiiCustom.cache.elementTop=clearCss(MoreiiCustom.cache.activeElement.css("top")),MoreiiCustom.cache.elementLeft=clearCss(MoreiiCustom.cache.activeElement.css("left"))},checkEdge=function(e,t){var i=clearCss(e.css("top")),o=clearCss(e.css("left")),c=t.width(),a=t.height();if(0>i||0>o||i>a-MoreiiCustom.cache.elementHeight||o>c-MoreiiCustom.cache.elementWidth){if(void 0===e.attr("data-group"))e.attr("data-group",MoreiiCustom.cache.getGroup());else for(var s=e.attr("data-group"),n=($("#canvas>div[data-group="+s+"]").get(0),$("#canvas>div[data-group="+s+"]")),m=n.length,r=0;m>r;r++)e.get(0)!==n.get(r)&&$(n.get(r)).remove();if(0>o)if(0>i){var l=e.clone(!0);l.css({top:i+"px",left:c+o+"px"}),t.append(l);var u=e.clone(!0);u.css({top:a+i+"px",left:c+o+"px"}),t.append(u);var h=e.clone(!0);h.css({top:a+i+"px",left:o+"px"}),t.append(h)}else if(i<a-MoreiiCustom.cache.elementHeight){var d=e.clone(!0);d.css({top:i+"px",left:c+o+"px"}),t.append(d)}else{var l=e.clone(!0);l.css({top:i-a+"px",left:c+o+"px"}),t.append(l);var u=e.clone(!0);u.css({top:i+"px",left:c+o+"px"}),t.append(u);var p=e.clone(!0);p.css({top:i-a+"px",left:o+"px"}),t.append(p)}else if(o<c-MoreiiCustom.cache.elementWidth){if(0>i){var f=e.clone(!0);f.css({top:i+a+"px",left:o+"px"}),t.append(f)}else if(i>a-MoreiiCustom.cache.elementHeight){var v=e.clone(!0);v.css({top:i-a+"px",left:o+"px"}),t.append(v)}}else if(0>i){var p=e.clone(!0);p.css({top:i+"px",left:o-c+"px"}),t.append(p);var u=e.clone(!0);u.css({top:i+a+"px",left:o+"px"}),t.append(u);var h=e.clone(!0);h.css({top:i+a+"px",left:o-c+"px"}),t.append(h)}else if(i<a-MoreiiCustom.cache.elementHeight){var g=e.clone(!0);g.css({top:i+"px",left:o-c+"px"}),t.append(g)}else{var p=e.clone(!0);p.css({top:i-a+"px",left:o-c+"px"}),t.append(p);var l=e.clone(!0);l.css({top:i-a+"px",left:o+"px"}),t.append(l);var h=e.clone(!0);h.css({top:i+"px",left:o-c+"px"}),t.append(h)}}else{var s=e.attr("data-group");if(void 0!==s)for(var n=($("#canvas>div[data-group="+s+"]").get(0),$("#canvas>div[data-group="+s+"]")),m=n.length,r=0;m>r;r++)e.get(0)!==n.get(r)&&$(n.get(r)).remove()}},refreshWall=function(){reDraw()},buildCustomData=function(){var e=[],t=$("#canvas>div");return $.each(t,function(t,i){var o=$(i);e.push({top:clearCss(o.css("top")),left:clearCss(o.css("left")),width:o.width(),height:o.height(),img:o.find("img").attr("src")})}),e},reDraw=function(){var e=document.getElementById("redrawcanvas"),t=e.getContext("2d");t.clearRect(0,0,500,500);for(var i=buildCustomData(),o=0;o<i.length;o++){var c=i[o].img,a=c.match(/(\w+)\/\w+\.\w+$/);a&&(a=a[1]);var s="mii_"+c.match(/\w+\.\w+$/)[0].replace(".","_");t.drawImage(MoreiiCustom.cache.image[a][s],i[o].left,i[o].top,i[o].width,MoreiiCustom.cache.image[a][s].height*i[o].width/MoreiiCustom.cache.image[a][s].width)}var n=e.toDataURL("image/png"),m=$("#canvas").offset().left%500;$("#wall").css({background:"url("+n+")","background-position":m+"px "+($("#canvas").offset().top+20)+"px"})},reDraw4print=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),i=document.createElement("canvas"),o=i.getContext("2d"),c=500,a=10,s=a/2.54*300,n={width:10,height:10};i.width=n.width/2.54*300*10,i.height=n.height/2.54*300*10,e.width=s,e.height=s,t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height);for(var m=s/c,r=buildCustomData(),l=0;l<r.length;l++){var u=r[l].img,h=u.match(/(\w+)\/\w+\.\w+$/);h&&(h=h[1]);var d="mii_"+u.match(/\w+\.\w+$/)[0].replace(".","_"),p=r[l].left*m,f=r[l].top*m,v=r[l].width*m,g=MoreiiCustom.cache.image[h][d].height*r[l].width/MoreiiCustom.cache.image[h][d].width*m;t.drawImage(MoreiiCustom.cache.image[h][d],p,f,v,g)}for(var l=0;l<n.width;l++)for(var C=0;C<n.height;C++)o.drawImage(e,l*a/2.54*300,C*a/2.54*300);$.ajax({type:"POST",url:"/api/custom/build4print",data:{imgData:i.toDataURL("image/png")},success:function(e){console.log(e)},dataType:"text"})};$(function(){MoreiiCustom.loadImage2Cache();var t=$("#canvas");MoreiiCustom.resizeWall(),setTimeout(function(){MoreiiCustom.resizeToolbar()},500),$(window).on("resize",function(){MoreiiCustom.resizeWall(),MoreiiCustom.resizeToolbar()}),$("#styleelementlist").slick({auto:!0,slidesToShow:15,slidesToScroll:10}),$(document).on("mousemove",function(e){switch(e.preventDefault(),!0){case mouseState.addElement():dragElementFromStylelist(e),overElement(e,t)?t.addClass("active"):t.removeClass("active");break;case mouseState.moveElement():MoreiiCustom.cache.activeElement.css({top:e.pageY-MoreiiCustom.cache.ePageX2elementTop+"px",left:e.pageX-MoreiiCustom.cache.ePageY2elementLeft+"px"}),reDraw();break;case 3===mouseState.resize:var i=e.pageX-MoreiiCustom.cache.activeElement.offset().left,o=e.pageY-MoreiiCustom.cache.activeElement.offset().top,c=clearCss(MoreiiCustom.cache.activeElement.css("width")),a=clearCss(MoreiiCustom.cache.activeElement.css("height")),s=1;i>0&&o>0&&(i>c?o>a&&(i/c>o/a?(s=o/a,i=c*s,MoreiiCustom.cache.activeElement.css({width:i+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%")):(s=i/c,o=a*s,MoreiiCustom.cache.activeElement.css({width:i+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%"))):a>o&&(o/a>i/c?(s=o/a,i=c*s,MoreiiCustom.cache.activeElement.css({width:i+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%")):(s=i/c,o=a*s,MoreiiCustom.cache.activeElement.css({width:i+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%"))),refreshResize(),refreshElementCache(),checkEdge(MoreiiCustom.cache.activeElement,t));break;case 4===mouseState.resize:var i=MoreiiCustom.cache.activeElement.offset().left-e.pageX+clearCss(MoreiiCustom.cache.activeElement.css("width")),o=e.pageY-MoreiiCustom.cache.activeElement.offset().top,c=clearCss(MoreiiCustom.cache.activeElement.css("width")),a=clearCss(MoreiiCustom.cache.activeElement.css("height")),s=1;if(i>0&&o>0){if(i>c&&o>a)if(i/c>o/a){s=o/a,i=a*s;var n=clearCss(MoreiiCustom.cache.activeElement.css("left"))-i+c;MoreiiCustom.cache.activeElement.css({width:i+"px",left:n+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%")}else{var n=clearCss(MoreiiCustom.cache.activeElement.css("left"))-i+c;MoreiiCustom.cache.activeElement.css({width:i+"px",left:n+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%")}else if(c>i&&a>o)if(o/a>i/c){s=o/a,i=a*s;var n=clearCss(MoreiiCustom.cache.activeElement.css("left"))-i+c;MoreiiCustom.cache.activeElement.css({width:i+"px",left:n+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%")}else{var n=clearCss(MoreiiCustom.cache.activeElement.css("left"))-i+c;MoreiiCustom.cache.activeElement.css({width:i+"px",left:n+"px"}),$(MoreiiCustom.cache.activeElement.find("img")).css("width","100%")}refreshResize(),refreshElementCache(),checkEdge(MoreiiCustom.cache.activeElement,t)}}}),$(document).on("mousedown","#styleelementlist .shadow",function(e){1===e.which&&(mouseState.addElement(!0),MoreiiCustom.cache.elementSrc=$($($(this).siblings(".img")).find("img")).attr("src"),$("#addElement").remove(),$("body").append('<div id="addElement"><img src="'+MoreiiCustom.cache.elementSrc+'"/></div>'))}),$(document).on("mouseup",function(e){if(1===e.which)switch(!0){case mouseState.addElement():if(overElement(e,t)){var i=MoreiiCustom.cache.elementTop-t.offset().top,o=MoreiiCustom.cache.elementLeft-t.offset().left;t.append('<div style="top:'+i+"px;left:"+o+'px "><img src="'+MoreiiCustom.cache.elementSrc+'"/></div>'),checkEdge($("#canvas>div:last"),t),refreshWall()}mouseState.addElement(!1),$("#addElement").remove(),t.removeClass("active");break;case mouseState.moveElement():mouseState.moveElement(!1),checkEdge(MoreiiCustom.cache.activeElement,t),refreshWall(),window.setTimeout(function(){mouseState.selectedElement(!0)},100);break;case mouseState.resize!==!1:mouseState.resize=!1,refreshWall()}}),$(document).on("mouseenter","#canvas",function(){}),$(document).on("mouseleave","#canvas",function(){mouseState.addElement()}),$(document).on("mouseup","#canvas",function(){}),$(document).on("mousedown","#canvas>div,#resize-0",function(e){if(1===e.which){if($("#contextmenu").hide(),mouseState.moveElement(!0),"resize-0"===$(this).attr("id"))var t=MoreiiCustom.cache.activeElement;else{var t=$(this);MoreiiCustom.cache.activeElement=t}MoreiiCustom.cache.elementTop=clearCss(t.css("top")),MoreiiCustom.cache.elementLeft=clearCss(t.css("left")),MoreiiCustom.cache.ePageX2elementTop=e.pageY-MoreiiCustom.cache.elementTop,MoreiiCustom.cache.ePageY2elementLeft=e.pageX-MoreiiCustom.cache.elementLeft,mouseState.selectedElement(!1)}else 3===e.which&&("resize-0"!==$(this).attr("id")&&(MoreiiCustom.cache.activeElement=$(this),refreshResize()),$("#contextmenu").css({top:e.pageY+"px",left:e.pageX+"px"}).show());return e&&e.preventDefault?e.preventDefault():window.event.returnValue=!1,!1}),$(document).on("click","#previewbutton",function(e){if(1===e.which){var t=$("#wall").css("background-image"),i=$("#wall").css("background-position"),o=$("#preview");o.css({"background-image":t,"background-position":i}),o.fadeIn()}}),$(document).on("click","#closepreview",function(e){1===e.which&&$("#preview").fadeOut()}),$(document).on("mousedown","#resize-1",function(e){1===e.which&&(mouseState.resize=1)}),$(document).on("mousedown","#resize-2",function(e){1===e.which&&(mouseState.resize=2)}),$(document).on("mousedown","#resize-3",function(e){1===e.which&&(mouseState.resize=3)}),$(document).on("mousedown","#resize-4",function(e){1===e.which&&(mouseState.resize=4,console.log("set 4"))}),$(document).on("click","#wall",function(e){1===e.which&&mouseState.selectedElement()&&mouseState.selectedElement(!1)}),$(document).on("click","#toolbar #tab .tabitem",function(){var e=$(this).attr("id");switch($("#toolbar #tab .tabitem").removeClass("active"),$(this).addClass("active"),$("#toolbar #panel>div").hide(),e){case"elementList":$("#styleelementlist").show();break;case"setbackgroundcolor":var t=$("#backgroundcolor"),i=$("#panel").height()-70;$(".bgcoloritem").height(i).width(i),t.show()}}),$(document).on("click",".bgcoloritem",function(){$("#backgroundcolor .bgcoloritem").removeClass("active"),$(this).addClass("active");var e=$(this).css("background-color");t.css("background-color",e),refreshWall()}),$(document).bind("contextmenu",function(){return!1}),$(document).on("mousedown","#contextmenu ul li",function(){var t=$(this).data("miido");switch(t){case"delete":var i=MoreiiCustom.cache.activeElement;i.remove(),MoreiiCustom.cache.activeElement=$("#canvas>div:last"),reDraw()}return $("#resize").hide(),$("#contextmenu").hide(),e&&e.preventDefault?e.preventDefault():window.event.returnValue=!1,!1}),$(document).on("mousedown",function(){$("#contextmenu").hide()})});